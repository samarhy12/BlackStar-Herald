{% extends "admin_base.html" %} {% block title %}Manage Categories{% endblock %}
{% block content %}
<div class="mb-8">
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
    <div>
      <h1 class="text-3xl font-bold text-gray-900 mb-2">Categories</h1>
      <p class="text-gray-600">Manage your content categories</p>
    </div>
    <button
      onclick="openCreateModal()"
      class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300 shadow-lg hover:shadow-xl flex items-center gap-2"
    >
      <i class="fas fa-plus-circle"></i>
      <span>Add New Category</span>
    </button>
  </div>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600 mb-1">Total Categories</p>
        <p class="text-3xl font-bold text-gray-900">{{ stats.total }}</p>
      </div>
      <div
        class="w-14 h-14 bg-blue-100 rounded-xl flex items-center justify-center"
      >
        <i class="fas fa-folder text-blue-600 text-2xl"></i>
      </div>
    </div>
  </div>

  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600 mb-1">Most Used</p>
        <p class="text-xl font-bold text-gray-900">
          {{ stats.most_used.name if stats.most_used else 'N/A' }}
        </p>
      </div>
      <div
        class="w-14 h-14 bg-green-100 rounded-xl flex items-center justify-center"
      >
        <i class="fas fa-star text-green-600 text-2xl"></i>
      </div>
    </div>
  </div>

  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600 mb-1">Total Articles</p>
        <p class="text-3xl font-bold text-gray-900">
          {{ stats.total_articles }}
        </p>
      </div>
      <div
        class="w-14 h-14 bg-purple-100 rounded-xl flex items-center justify-center"
      >
        <i class="fas fa-newspaper text-purple-600 text-2xl"></i>
      </div>
    </div>
  </div>

  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600 mb-1">Empty Categories</p>
        <p class="text-3xl font-bold text-gray-900">{{ stats.empty }}</p>
      </div>
      <div
        class="w-14 h-14 bg-orange-100 rounded-xl flex items-center justify-center"
      >
        <i class="fas fa-inbox text-orange-600 text-2xl"></i>
      </div>
    </div>
  </div>
</div>

<!-- Categories Table -->
<div
  class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"
>
  <div class="p-6 border-b border-gray-200">
    <div
      class="flex flex-col md:flex-row md:items-center justify-between gap-4"
    >
      <h2 class="text-lg font-bold text-gray-900">All Categories</h2>
      <div class="flex items-center gap-3">
        <div class="relative">
          <input
            type="text"
            id="search-input"
            placeholder="Search categories..."
            class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-sm"
          />
          <i
            class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"
          ></i>
        </div>
      </div>
    </div>
  </div>

  <div class="overflow-x-auto">
    <table class="w-full">
      <thead class="bg-gray-50 border-b border-gray-200">
        <tr>
          <th
            class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
          >
            Category
          </th>
          <th
            class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
          >
            Slug
          </th>
          <th
            class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
          >
            Description
          </th>
          <th
            class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider"
          >
            Articles
          </th>
          <th
            class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider"
          >
            Actions
          </th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200" id="categories-tbody">
        {% for category in categories %}
        <tr
          class="hover:bg-gray-50 transition-colors category-row"
          data-search="{{ category.name|lower }} {{ category.slug|lower }}"
        >
          <td class="px-6 py-4">
            <div class="flex items-center gap-3">
              <div class="text-3xl">{{ category.icon }}</div>
              <div>
                <p class="font-semibold text-gray-900">{{ category.name }}</p>
                <span
                  class="{{ category.color }} text-white px-2 py-1 rounded text-xs font-medium mt-1 inline-block"
                >
                  Preview
                </span>
              </div>
            </div>
          </td>
          <td class="px-6 py-4">
            <code class="bg-gray-100 px-2 py-1 rounded text-sm text-gray-700"
              >{{ category.slug }}</code
            >
          </td>
          <td class="px-6 py-4">
            <p class="text-sm text-gray-600 max-w-xs">
              {{ category.description or 'No description' }}
            </p>
          </td>
          <td class="px-6 py-4 text-center">
            <span
              class="inline-flex items-center justify-center w-10 h-10 bg-blue-100 text-blue-600 rounded-full font-semibold"
            >
              {{ category.article_count }}
            </span>
          </td>
          <td class="px-6 py-4">
            <div class="flex items-center justify-center gap-2">
              <button
                onclick="openEditModal({{ category.id }})"
                class="text-blue-600 hover:text-blue-800 hover:bg-blue-50 p-2 rounded-lg transition-colors"
                title="Edit"
              >
                <i class="fas fa-edit"></i>
              </button>
              <button
                onclick="deleteCategory({{ category.id }}, '{{ category.name }}', {{ category.article_count }})"
                class="text-red-600 hover:text-red-800 hover:bg-red-50 p-2 rounded-lg transition-colors"
                title="Delete"
                {%
                if
                category.article_count
              >
                0 %}disabled class="opacity-50 cursor-not-allowed"{% endif %} >
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if categories|length == 0 %}
  <div class="p-12 text-center">
    <i class="fas fa-folder-open text-gray-300 text-6xl mb-4"></i>
    <p class="text-gray-500 text-lg font-medium">No categories yet</p>
    <p class="text-gray-400 text-sm mt-2">
      Click "Add New Category" to create your first category
    </p>
  </div>
  {% endif %}
</div>

<!-- Create/Edit Category Modal -->
<div
  id="category-modal"
  class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4"
  onclick="closeModal(event)"
>
  <div
    class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
    onclick="event.stopPropagation()"
  >
    <div class="p-6 border-b border-gray-200">
      <div class="flex items-center justify-between">
        <h3 class="text-2xl font-bold text-gray-900" id="modal-title">
          Add New Category
        </h3>
        <button
          onclick="closeModal()"
          class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 p-2 rounded-lg transition-colors"
        >
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
    </div>

    <form id="category-form" class="p-6 space-y-6">
      <input type="hidden" id="category-id" />

      <!-- Name -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          Category Name <span class="text-red-500">*</span>
        </label>
        <input
          type="text"
          id="category-name"
          required
          class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all"
          placeholder="e.g., Politics, Sports, Technology"
        />
      </div>

      <!-- Slug -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          Slug <span class="text-red-500">*</span>
        </label>
        <input
          type="text"
          id="category-slug"
          required
          class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all"
          placeholder="e.g., politics, sports, technology"
        />
        <p class="text-xs text-gray-500 mt-1">
          URL-friendly version (lowercase, no spaces, use hyphens)
        </p>
      </div>

      <!-- Icon -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          Icon (Emoji) <span class="text-red-500">*</span>
        </label>
        <input
          type="text"
          id="category-icon"
          required
          maxlength="2"
          class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-2xl"
          placeholder="üèõÔ∏è"
        />
        <p class="text-xs text-gray-500 mt-1">
          Common icons: üèõÔ∏è (Politics), üíº (Business), ‚öΩ (Sports), üé¨
          (Entertainment), üíª (Tech), üè• (Health), üìö (Education)
        </p>
      </div>

      <!-- Color -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          Color <span class="text-red-500">*</span>
        </label>
        <select
          id="category-color"
          required
          class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all"
        >
          <option value="bg-blue-600">Blue</option>
          <option value="bg-green-600">Green</option>
          <option value="bg-red-600">Red</option>
          <option value="bg-purple-600">Purple</option>
          <option value="bg-indigo-600">Indigo</option>
          <option value="bg-pink-600">Pink</option>
          <option value="bg-yellow-600">Yellow</option>
          <option value="bg-orange-600">Orange</option>
          <option value="bg-teal-600">Teal</option>
          <option value="bg-cyan-600">Cyan</option>
        </select>
        <div class="mt-3 flex items-center gap-2">
          <span class="text-sm text-gray-600">Preview:</span>
          <span
            id="color-preview"
            class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-medium"
          >
            Category
          </span>
        </div>
      </div>

      <!-- Description -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          Description
        </label>
        <textarea
          id="category-description"
          rows="3"
          class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all resize-none"
          placeholder="Brief description of this category"
        ></textarea>
      </div>

      <!-- Form Actions -->
      <div
        class="flex items-center justify-end gap-3 pt-4 border-t border-gray-200"
      >
        <button
          type="button"
          onclick="closeModal()"
          class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50 transition-colors"
        >
          Cancel
        </button>
        <button
          type="submit"
          class="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-lg font-semibold transition-all shadow-lg hover:shadow-xl"
        >
          <i class="fas fa-save mr-2"></i>
          <span id="submit-btn-text">Create Category</span>
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  // Auto-generate slug from name
  document
    .getElementById("category-name")
    .addEventListener("input", function (e) {
      const slug = e.target.value
        .toLowerCase()
        .replace(/[^\w\s-]/g, "")
        .replace(/\s+/g, "-")
        .replace(/-+/g, "-")
        .trim();
      document.getElementById("category-slug").value = slug;
    });

  // Color preview
  document
    .getElementById("category-color")
    .addEventListener("change", function (e) {
      const preview = document.getElementById("color-preview");
      preview.className = `${e.target.value} text-white px-3 py-1 rounded text-xs font-medium`;
    });

  // Search functionality
  document
    .getElementById("search-input")
    .addEventListener("input", function (e) {
      const searchTerm = e.target.value.toLowerCase();
      const rows = document.querySelectorAll(".category-row");

      rows.forEach((row) => {
        const searchText = row.getAttribute("data-search");
        if (searchText.includes(searchTerm)) {
          row.style.display = "";
        } else {
          row.style.display = "none";
        }
      });
    });

  function openCreateModal() {
    document.getElementById("modal-title").textContent = "Add New Category";
    document.getElementById("submit-btn-text").textContent = "Create Category";
    document.getElementById("category-form").reset();
    document.getElementById("category-id").value = "";
    document.getElementById("color-preview").className =
      "bg-blue-600 text-white px-3 py-1 rounded text-xs font-medium";
    document.getElementById("category-modal").classList.remove("hidden");
    document.getElementById("category-modal").classList.add("flex");
  }

  function openEditModal(categoryId) {
    document.getElementById("modal-title").textContent = "Edit Category";
    document.getElementById("submit-btn-text").textContent = "Update Category";

    // Fetch category data
    fetch(`/admin/categories/${categoryId}`)
      .then((res) => res.json())
      .then((data) => {
        document.getElementById("category-id").value = data.id;
        document.getElementById("category-name").value = data.name;
        document.getElementById("category-slug").value = data.slug;
        document.getElementById("category-icon").value = data.icon;
        document.getElementById("category-color").value = data.color;
        document.getElementById("category-description").value =
          data.description || "";

        const preview = document.getElementById("color-preview");
        preview.className = `${data.color} text-white px-3 py-1 rounded text-xs font-medium`;

        document.getElementById("category-modal").classList.remove("hidden");
        document.getElementById("category-modal").classList.add("flex");
      })
      .catch((err) => {
        alert("Error loading category data");
        console.error(err);
      });
  }

  function closeModal(event) {
    if (!event || event.target.id === "category-modal") {
      document.getElementById("category-modal").classList.add("hidden");
      document.getElementById("category-modal").classList.remove("flex");
    }
  }

  // Form submission
  document
    .getElementById("category-form")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      const categoryId = document.getElementById("category-id").value;
      const data = {
        name: document.getElementById("category-name").value,
        slug: document.getElementById("category-slug").value,
        icon: document.getElementById("category-icon").value,
        color: document.getElementById("category-color").value,
        description: document.getElementById("category-description").value,
      };

      const url = categoryId
        ? `/admin/categories/${categoryId}/update`
        : "/admin/categories/create";

      try {
        const response = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (response.ok) {
          window.location.reload();
        } else {
          alert(result.error || "An error occurred");
        }
      } catch (error) {
        alert("Network error. Please try again.");
        console.error(error);
      }
    });

  function deleteCategory(categoryId, categoryName, articleCount) {
    if (articleCount > 0) {
      alert(
        `Cannot delete "${categoryName}" because it has ${articleCount} article(s). Please move or delete the articles first.`,
      );
      return;
    }

    if (
      !confirm(
        `Are you sure you want to delete the category "${categoryName}"?`,
      )
    ) {
      return;
    }

    fetch(`/admin/categories/${categoryId}/delete`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.success) {
          window.location.reload();
        } else {
          alert(data.error || "Error deleting category");
        }
      })
      .catch((err) => {
        alert("Network error");
        console.error(err);
      });
  }

  // Close modal with Escape key
  document.addEventListener("keydown", function (e) {
    if (e.key === "Escape") {
      closeModal();
    }
  });
</script>
{% endblock %}
