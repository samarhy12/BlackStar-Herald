{% extends "admin_base.html" %} {% block title %}Newsletter Subscribers{%
endblock %} {% block content %}
<!-- Header -->
<div
  class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6"
>
  <div>
    <h1 class="text-2xl md:text-3xl font-bold text-gray-900">
      Newsletter Subscribers
    </h1>
    <p class="text-gray-600 mt-1 md:mt-2">
      Manage your email subscribers and send campaigns
    </p>
  </div>
  <div class="flex gap-2">
    <button
      onclick="exportSubscribers()"
      class="inline-flex items-center justify-center bg-green-600 hover:bg-green-700 text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-bold transition shadow-lg gap-2 text-sm md:text-base"
    >
      <i class="fas fa-download"></i>
      <span>Export CSV</span>
    </button>
  </div>
</div>

<!-- Stats Grid -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-8">
  <div
    class="bg-white rounded-2xl shadow-lg p-4 md:p-6 border-l-4 border-blue-600"
  >
    <div class="flex items-center justify-between mb-4">
      <div
        class="bg-blue-100 text-blue-600 w-12 h-12 md:w-14 md:h-14 rounded-xl flex items-center justify-center"
      >
        <i class="fas fa-users text-xl md:text-2xl"></i>
      </div>
    </div>
    <p class="text-gray-500 text-xs md:text-sm font-medium mb-1">
      Total Subscribers
    </p>
    <p class="text-3xl md:text-4xl font-bold text-gray-900">
      {{ stats.total }}
    </p>
  </div>

  <div
    class="bg-white rounded-2xl shadow-lg p-4 md:p-6 border-l-4 border-green-600"
  >
    <div class="flex items-center justify-between mb-4">
      <div
        class="bg-green-100 text-green-600 w-12 h-12 md:w-14 md:h-14 rounded-xl flex items-center justify-center"
      >
        <i class="fas fa-user-plus text-xl md:text-2xl"></i>
      </div>
    </div>
    <p class="text-gray-500 text-xs md:text-sm font-medium mb-1">This Month</p>
    <p class="text-3xl md:text-4xl font-bold text-gray-900">
      {{ stats.this_month }}
    </p>
  </div>

  <div
    class="bg-white rounded-2xl shadow-lg p-4 md:p-6 border-l-4 border-purple-600"
  >
    <div class="flex items-center justify-between mb-4">
      <div
        class="bg-purple-100 text-purple-600 w-12 h-12 md:w-14 md:h-14 rounded-xl flex items-center justify-center"
      >
        <i class="fas fa-calendar-week text-xl md:text-2xl"></i>
      </div>
    </div>
    <p class="text-gray-500 text-xs md:text-sm font-medium mb-1">This Week</p>
    <p class="text-3xl md:text-4xl font-bold text-gray-900">
      {{ stats.this_week }}
    </p>
  </div>

  <div
    class="bg-white rounded-2xl shadow-lg p-4 md:p-6 border-l-4 border-orange-600"
  >
    <div class="flex items-center justify-between mb-4">
      <div
        class="bg-orange-100 text-orange-600 w-12 h-12 md:w-14 md:h-14 rounded-xl flex items-center justify-center"
      >
        <i class="fas fa-calendar-day text-xl md:text-2xl"></i>
      </div>
    </div>
    <p class="text-gray-500 text-xs md:text-sm font-medium mb-1">Today</p>
    <p class="text-3xl md:text-4xl font-bold text-gray-900">
      {{ stats.today }}
    </p>
  </div>
</div>

<!-- Search and Filter -->
<div
  class="bg-white rounded-xl shadow-lg p-4 md:p-6 mb-6 border border-gray-200"
>
  <div class="flex flex-col md:flex-row gap-4">
    <div class="flex-1">
      <div class="relative">
        <i
          class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"
        ></i>
        <input
          type="text"
          id="search-input"
          placeholder="Search by email..."
          class="w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition"
        />
      </div>
    </div>
    <div class="flex gap-2">
      <select
        id="sort-select"
        class="px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 transition font-medium"
      >
        <option value="newest">Newest First</option>
        <option value="oldest">Oldest First</option>
        <option value="email">Email A-Z</option>
      </select>
    </div>
  </div>
</div>

<!-- Desktop Table View -->
<div
  class="hidden md:block bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200"
>
  <div class="overflow-x-auto">
    <table class="w-full">
      <thead
        class="bg-gradient-to-r from-gray-50 to-gray-100 border-b-2 border-gray-200"
      >
        <tr>
          <th
            class="px-4 lg:px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider"
          >
            <input
              type="checkbox"
              id="select-all"
              class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
            />
          </th>
          <th
            class="px-4 lg:px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider"
          >
            #
          </th>
          <th
            class="px-4 lg:px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider"
          >
            Email Address
          </th>
          <th
            class="px-4 lg:px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider"
          >
            Subscribed Date
          </th>
          <th
            class="px-4 lg:px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider"
          >
            Status
          </th>
          <th
            class="px-4 lg:px-6 py-4 text-right text-xs font-bold text-gray-700 uppercase tracking-wider"
          >
            Actions
          </th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200" id="subscribers-table">
        {% if subscribers %} {% for subscriber in subscribers %}
        <tr
          class="hover:bg-gray-50 transition"
          data-email="{{ subscriber.email }}"
          data-date="{{ subscriber.subscribed_at }}"
        >
          <td class="px-4 lg:px-6 py-4">
            <input
              type="checkbox"
              class="subscriber-checkbox w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
              value="{{ subscriber.id }}"
            />
          </td>
          <td class="px-4 lg:px-6 py-4">
            <span class="text-gray-500 font-medium">{{ loop.index }}</span>
          </td>
          <td class="px-4 lg:px-6 py-4">
            <div class="flex items-center gap-3">
              <div
                class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-500 flex items-center justify-center text-white font-bold"
              >
                {{ subscriber.email[0].upper() }}
              </div>
              <div>
                <p class="font-medium text-gray-900">{{ subscriber.email }}</p>
                <p class="text-xs text-gray-500">Subscriber</p>
              </div>
            </div>
          </td>
          <td class="px-4 lg:px-6 py-4">
            <div class="flex flex-col">
              <span class="text-sm text-gray-900 font-medium"
                >{{ subscriber.subscribed_at[:10] }}</span
              >
              <span class="text-xs text-gray-500"
                >{{ subscriber.subscribed_at[:10] }}</span
              >
            </div>
          </td>
          <td class="px-4 lg:px-6 py-4">
            <span
              class="px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700"
            >
              <i class="fas fa-check-circle mr-1"></i>Active
            </span>
          </td>
          <td class="px-4 lg:px-6 py-4 text-right">
            <button
              onclick="deleteSubscriber({{ subscriber.id }})"
              class="text-red-600 hover:text-red-700 p-2 hover:bg-red-50 rounded-lg transition"
              title="Delete"
            >
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
        {% endfor %} {% else %}
        <tr>
          <td colspan="6" class="px-6 py-12 text-center">
            <div class="text-gray-400">
              <i class="fas fa-inbox text-5xl mb-4"></i>
              <p class="text-lg font-medium text-gray-500">
                No subscribers yet
              </p>
              <p class="text-sm text-gray-400 mt-2">
                Start promoting your newsletter to grow your audience
              </p>
            </div>
          </td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Mobile Card View -->
<div class="md:hidden space-y-4" id="subscribers-mobile">
  {% if subscribers %} {% for subscriber in subscribers %}
  <div
    class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200"
    data-email="{{ subscriber.email }}"
    data-date="{{ subscriber.subscribed_at }}"
  >
    <div class="p-4">
      <div class="flex items-start justify-between mb-3">
        <div class="flex items-center gap-3">
          <input
            type="checkbox"
            class="subscriber-checkbox w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mt-1"
            value="{{ subscriber.id }}"
          />
          <div
            class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-indigo-500 flex items-center justify-center text-white font-bold text-lg"
          >
            {{ subscriber.email[0].upper() }}
          </div>
          <div class="flex-1">
            <p class="font-bold text-gray-900 text-sm break-all">
              {{ subscriber.email }}
            </p>
            <p class="text-xs text-gray-500">
              {{ subscriber.subscribed_at[:10] }}
            </p>
          </div>
        </div>
      </div>
      <div class="flex items-center justify-between">
        <span
          class="px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700"
        >
          <i class="fas fa-check-circle mr-1"></i>Active
        </span>
        <button
          onclick="deleteSubscriber({{ subscriber.id }})"
          class="text-red-600 hover:text-red-700 px-4 py-2 hover:bg-red-50 rounded-lg transition text-sm font-medium"
        >
          <i class="fas fa-trash mr-1"></i>Delete
        </button>
      </div>
    </div>
  </div>
  {% endfor %} {% else %}
  <div
    class="bg-white rounded-xl shadow-lg p-12 text-center border border-gray-200"
  >
    <i class="fas fa-inbox text-gray-300 text-6xl mb-4"></i>
    <p class="text-lg font-medium text-gray-500">No subscribers yet</p>
    <p class="text-sm text-gray-400 mt-2">
      Start promoting your newsletter to grow your audience
    </p>
  </div>
  {% endif %}
</div>

<!-- Bulk Actions Bar (shown when items selected) -->
<div
  id="bulk-actions"
  class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-4 rounded-2xl shadow-2xl hidden z-50"
>
  <div class="flex items-center gap-6">
    <span id="selected-count" class="font-bold">0 selected</span>
    <button
      onclick="bulkDelete()"
      class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg font-medium transition"
    >
      <i class="fas fa-trash mr-2"></i>Delete Selected
    </button>
    <button onclick="clearSelection()" class="text-gray-300 hover:text-white">
      <i class="fas fa-times"></i>
    </button>
  </div>
</div>

{% endblock %} {% block extra_js %}
<script>
  // Search functionality
  document
    .getElementById("search-input")
    .addEventListener("input", function (e) {
      const searchTerm = e.target.value.toLowerCase();
      const rows = document.querySelectorAll(
        "#subscribers-table tr[data-email], #subscribers-mobile > div[data-email]",
      );

      rows.forEach((row) => {
        const email = row.getAttribute("data-email").toLowerCase();
        row.style.display = email.includes(searchTerm) ? "" : "none";
      });
    });

  // Sort functionality
  document
    .getElementById("sort-select")
    .addEventListener("change", function (e) {
      const sortBy = e.target.value;
      const tableBody = document.getElementById("subscribers-table");
      const mobileContainer = document.getElementById("subscribers-mobile");

      const rows = Array.from(
        tableBody ? tableBody.querySelectorAll("tr[data-email]") : [],
      );
      const cards = Array.from(
        mobileContainer
          ? mobileContainer.querySelectorAll("div[data-email]")
          : [],
      );

      const sortFn = (a, b) => {
        if (sortBy === "newest") {
          return (
            new Date(b.getAttribute("data-date")) -
            new Date(a.getAttribute("data-date"))
          );
        } else if (sortBy === "oldest") {
          return (
            new Date(a.getAttribute("data-date")) -
            new Date(b.getAttribute("data-date"))
          );
        } else {
          return a
            .getAttribute("data-email")
            .localeCompare(b.getAttribute("data-email"));
        }
      };

      if (rows.length) {
        rows.sort(sortFn).forEach((row) => tableBody.appendChild(row));
      }
      if (cards.length) {
        cards.sort(sortFn).forEach((card) => mobileContainer.appendChild(card));
      }
    });

  // Select all checkbox
  document
    .getElementById("select-all")
    ?.addEventListener("change", function (e) {
      document.querySelectorAll(".subscriber-checkbox").forEach((cb) => {
        cb.checked = e.target.checked;
      });
      updateBulkActions();
    });

  // Individual checkboxes
  document.querySelectorAll(".subscriber-checkbox").forEach((cb) => {
    cb.addEventListener("change", updateBulkActions);
  });

  function updateBulkActions() {
    const checked = document.querySelectorAll(".subscriber-checkbox:checked");
    const bulkActions = document.getElementById("bulk-actions");
    const selectedCount = document.getElementById("selected-count");

    if (checked.length > 0) {
      bulkActions.classList.remove("hidden");
      selectedCount.textContent = `${checked.length} selected`;
    } else {
      bulkActions.classList.add("hidden");
    }
  }

  function clearSelection() {
    document.querySelectorAll(".subscriber-checkbox").forEach((cb) => {
      cb.checked = false;
    });
    if (document.getElementById("select-all")) {
      document.getElementById("select-all").checked = false;
    }
    updateBulkActions();
  }

  async function deleteSubscriber(id) {
    if (!confirm("Are you sure you want to delete this subscriber?")) return;

    try {
      const response = await fetch(`/admin/newsletter/${id}/delete`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });

      if (response.ok) {
        location.reload();
      } else {
        alert("Failed to delete subscriber");
      }
    } catch (error) {
      alert("Error deleting subscriber");
    }
  }

  async function bulkDelete() {
    const checked = Array.from(
      document.querySelectorAll(".subscriber-checkbox:checked"),
    ).map((cb) => cb.value);

    if (!confirm(`Delete ${checked.length} subscribers?`)) return;

    try {
      const response = await fetch("/admin/newsletter/bulk-delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ids: checked }),
      });

      if (response.ok) {
        location.reload();
      } else {
        alert("Failed to delete subscribers");
      }
    } catch (error) {
      alert("Error deleting subscribers");
    }
  }

  function exportSubscribers() {
    window.location.href = "/admin/newsletter/export";
  }
</script>
{% endblock %}
